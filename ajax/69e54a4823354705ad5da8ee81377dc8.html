<?php
  include 'ajax.php';

/**
 * SocketLabs HTTP injection API sample for merging messages
**/
header('Content-Type: application/json');

  if(validEmail($_POST['email']) === true){
    //~ proceed with the send
    $msg = '';
    foreach($_POST as $p => $v){
      $msg .= "$p ..... ".htmlentities($v)."<br />";
    }
//build merge data
$merge_data = new stdClass();
$merge_data->PerMessage=array(
    array(array('Field'=>'DeliveryAddress', 'Value'=>$administrator))
    //~ array(array('Field'=>'DeliveryAddress', 'Value'=>'rwhitney@phpmydev.com'))
  );
//~ echo ' Create JSON object to POST to SocketLabs';
$data = new stdClass();
$data->ServerId=SOCKETLABS_SERVERID;
$data->ApiKey=SOCKETLABS_KEY;
$data->Messages= array(array('MergeData'=>$merge_data,
                        'Subject'=>'Inquiry at PHS Rhapsody',
                        'To'=>array(array('EmailAddress'=>'%%DeliveryAddress%%')),
                        'From'=>array('EmailAddress'=>$administrator),
                        'HtmlBody'=>'<div style="margin:0 auto;width:600px">'.$logo.'<br /><br/>'.$msg.'</div>'

                      ));
                      //~ echo $data;
$bodyJson = json_encode($data);
//echo $bodyJson;

//use CURL to POST the JSON to SocketLabs
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL,SOCKETLABS_URL);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1 );
curl_setopt($ch, CURLOPT_POST,           1 );
curl_setopt($ch, CURLOPT_POSTFIELDS,     $bodyJson );
curl_setopt($ch, CURLOPT_HTTPHEADER,     array('Content-Type: application/json'));
$result=curl_exec ($ch);
curl_close ($ch);

//process result
if ($result==false) {
  echo 'HTTP Error';
} else {
    $result_obj = json_decode($result);
    if ($result_obj->ErrorCode=='Success') {
       echo 'Successfully sent all messages.';
    } elseif ($result_obj->ErrorCode=='Warning') {
       echo 'At least one message was sent, but there are errors with one or more messages, or their recipients.';
       //not shown here, but you can traverse the MessageResults object to get more information on each message that encountered an error or warning
    } else {
       echo 'Failure Code: ' . $result_obj->ErrorCode;
    }
  }
}

