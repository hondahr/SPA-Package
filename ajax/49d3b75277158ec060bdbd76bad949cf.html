<?php
  include 'ajax.php';

/**
 * SocketLabs HTTP injection API sample for merging messages
 * 
 * Script: sendTracking
 * 
**/
header('Content-Type: application/json');

$order = getEmailForTracking($_POST['cartid']);
$products = explode(',',$_POST['product']);
foreach($products as $p=>$v){
  $product .= $v.'<br/> ';
}
$productHeader = substr($product,0,30);
$carrier = $_POST['carrier'];
$tracking = $_POST['tracking'];
$tracklink = $_POST['tracklink'];
$shipto = $_POST['shipto'];
$email = $order['email'];
//~ $email = 'jdk192@hotmail.com';
$name = $order['name'];
//build merge data
$merge_data = new stdClass();
$merge_data->PerMessage=array(
  array(
    array('Field'=>'DeliveryAddress', 'Value'=>$email),
    array('Field'=>'Name', 'Value'=>$name),
    array('Field'=>'Product', 'Value'=>$product),
    array('Field'=>'ProductHeader', 'Value'=>$productHeader),
    array('Field'=>'Tracking', 'Value'=>$tracking),
    array('Field'=>'TrackLink', 'Value'=>$tracklink),
    array('Field'=>'Carrier', 'Value'=>$carrier),
    array('Field'=>'ShipTo', 'Value'=>$shipto)
  )
);

// Create JSON object to POST to SocketLabs
$data = new stdClass();
$data->ServerId=SOCKETLABS_SERVERID;
$data->ApiKey=SOCKETLABS_KEY;
$data->Messages= array(array('MergeData'=>$merge_data,
                        'Subject'=>'Tracking info from AFS for %%ProductHeader%% ...',
                        'To'=>array(array('EmailAddress'=>'%%DeliveryAddress%%')),
                        'From'=>array('EmailAddress'=>$administrator),
                        'HtmlBody'=>'<div style="margin:0 auto;width:600px">'.$logo.'<br /><br />Dear %%Name%%,<br/>Some or all of your order has shipped.
                                    If you ordered multiple items they may ship from different locations.<br /> Please see tracking information for:<br/><br/>
                                    <h2>%%Product%% Tracking number is:<br/><a href="%%TrackLink%%">%%Tracking%%</a> with %%Carrier%%</h2>
                                    
                                    %%ShipTo%%
                                    
                                    <h3 style="background:#ccc;color:#fff">Merchant Contact Information</h3>
                                    
                                    </div>'

                      ));
$bodyJson = json_encode($data);
//echo $bodyJson;

//use CURL to POST the JSON to SocketLabs
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL,SOCKETLABS_URL);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1 );
curl_setopt($ch, CURLOPT_POST,           1 );
curl_setopt($ch, CURLOPT_POSTFIELDS,     $bodyJson );
curl_setopt($ch, CURLOPT_HTTPHEADER,     array('Content-Type: application/json'));
$result=curl_exec ($ch);
curl_close ($ch);

//process result
if ($result==false) {
  echo 'HTTP Error';
} else {
    $result_obj = json_decode($result);
    if ($result_obj->ErrorCode=='Success') {
       echo 'Successfully sent all messages.';
    } elseif ($result_obj->ErrorCode=='Warning') {
       echo 'At least one message was sent, but there are errors with one or more messages, or their recipients.';
       //not shown here, but you can traverse the MessageResults object to get more information on each message that encountered an error or warning
    } else {
       echo 'Failure Code: ' . $result_obj->ErrorCode;
    }
}

