<?php
include 'ajax.php';
/**
 * SocketLabs HTTP injection API sample for merging messages
 * 
 * Script: emailReceipt
 * 
**/

header('Content-Type: application/json');
$emails = $_POST['email'].','.$administrator;// comment when live
$ord = explode(',',$emails);
$product = explode('|',$_POST['products']);
foreach($product as $p => $v){
  $products .= "$v<br/><br />";
}

$name = explode('<br />',$_POST['name']);
$name = $name[0];

//build merge data
$merge_data = new stdClass();
$email = array();
for($i=0;$i<count($ord);$i++){
  $email = array_merge($email,array(
  array(
    array('Field'=>'DeliveryAddress', 'Value'=>$ord[$i]),
    array('Field'=>'Name', 'Value'=>$name),
    array('Field'=>'Billing', 'Value'=>$_POST['billing']),
    array('Field'=>'Shipping', 'Value'=>$_POST['shipping']),
    array('Field'=>'Phone', 'Value'=>$_POST['phone']),
    array('Field'=>'DateTime', 'Value'=>date('d-M-Y h:i:s A',strtotime($_POST['timestamp']))),
    //~ array('Field'=>'TXID', 'Value'=>$_POST['txid']),
    //~ array('Field'=>'PaymentDetails', 'Value'=>$_POST['paymentdetails']),
    //~ array('Field'=>'AuthCode', 'Value'=>$_POST['authcode']),
    array('Field'=>'Subtotal', 'Value'=>$_POST['subtotal']),
    array('Field'=>'ShipCost', 'Value'=>$_POST['shipcost']),
    array('Field'=>'Tax', 'Value'=>$_POST['tax']),
    array('Field'=>'Total', 'Value'=>$_POST['total']),
    array('Field'=>'Products', 'Value'=>$products),//include quantity at beginning
    array('Field'=>'OrderNumber', 'Value'=>$_POST['orderid'])
      )
    )
  );
}
$merge_data->PerMessage = $email;
// Create JSON object to POST to SocketLabs
$data = new stdClass();
$data->ServerId=SOCKETLABS_SERVERID;
$data->ApiKey=SOCKETLABS_KEY;
$data->Messages= array(array('MergeData'=>$merge_data,
                        'Subject'=>'Order Confirmation from '.$storeInitials,
                        'To'=>array(array('EmailAddress'=>'%%DeliveryAddress%%')),
                        'From'=>array('EmailAddress'=>$administrator),
                        'HtmlBody'=>'<div style="width:600px;margin:0 auto">'.$logo.'<br /><br />Dear %%Name%%,<br/><br/>Thank you for shopping with '.$nameOfStore.'.
                                    <br /><br />
                                    Please take a moment to review this summary and contact us immediately if any changes are necessary. Our Customer Care department can be reached by calling the number below or replying to this message.
                                    <br /><br />
                                    Updates will be sent via email regarding the status of this order.
                                    <br /><br />
                                    We appreciate the opportunity to serve you!
                                    <br /><br />
                                    Sincerely,
                                    <br /><br />
                                    '.$nameOfStore.'
                                    <a href="http://'.$storeUrl.'">'.$storeUrl.'</a><br/><br />
                                    '.$storePhone.'<br /><br />
                                    <h3 style="background:#ccc;color:#fff">Summary of Order %%OrderNumber%%</h3>
                                    <table>
                                      <tr>
                                        <td colspan=2>
                                          %%Products%%
                                          <br />Subtotal: $%%Subtotal%%
                                          <br />Shipping: $%%ShipCost%%
                                          <br />Tax: $%%Tax%%
                                          <br />Total: $%%Total%%
                                          
                                        </td>
                                        <td>

                                        </td>
                                      </tr>
                                    </table>
                                    <table>
                                      <tr>
                                        <td>
                                          <h3 style="background:#ccc;color:#fff">Customer Information</h3>
                                          Name: %%Name%%<br/>
                                          Email: %%DeliveryAddress%%<br/>
                                          Telephone: %%Phone%%<br/>
                                        </td>
                                        <td></td>
                                      </tr>
                                      <tr>
                                        <td>
                                          <b>Billing Address</b><br/>
                                          %%Billing%%<br/>
                                          
                                          
                                        </td>
                                        <td>
                                          <b>Shipping Address</b><br/>
                                          %%Shipping%%<br/>
                                        </td>
                                      </tr>
                                    </table>
                                    
                                    <h3 style="background:#ccc;color:#fff">Merchant Contact Information</h3>
                                    '.$nameOfStore.'
                                    '.$storeAddress.'
                                    </div>'

                      ));
$bodyJson = json_encode($data);
//echo $bodyJson;

//use CURL to POST the JSON to SocketLabs
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL,SOCKETLABS_URL);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1 );
curl_setopt($ch, CURLOPT_POST,           1 );
curl_setopt($ch, CURLOPT_POSTFIELDS,     $bodyJson );
curl_setopt($ch, CURLOPT_HTTPHEADER,     array('Content-Type: application/json'));
$result=curl_exec ($ch);
curl_close ($ch);

//process result
if ($result==false) {
  echo 'HTTP Error';
} else {
    $result_obj = json_decode($result);
    if ($result_obj->ErrorCode=='Success') {
       echo 'Successfully sent all messages.';
    } elseif ($result_obj->ErrorCode=='Warning') {
       echo 'At least one message was sent, but there are errors with one or more messages, or their recipients.';
       //not shown here, but you can traverse the MessageResults object to get more information on each message that encountered an error or warning
    } else {
       echo 'Failure Code: ' . $result_obj->ErrorCode;
    }
}
