<?php
include 'ajax.php';
/**
 * SocketLabs HTTP injection API sample for merging messages
*
* Script: socketLabs sample
* */

header('Content-Type: application/json');


//build merge data
$merge_data = new stdClass();
$merge_data->PerMessage=array(
  array(
    array('Field'=>'DeliveryAddress', 'Value'=>$_POST['email']),
    array('Field'=>'Name', 'Value'=>$_POST['name']),
    array('Field'=>'Billing', 'Value'=>$_POST['billing'])
    array('Field'=>'Shipping', 'Value'=>$_POST['shipping'])
    array('Field'=>'Phone', 'Value'=>$_POST['phone'])
    array('Field'=>'DateTime', 'Value'=>date('d-F-Y h:i:s A',strtotime($_POST['timestamp'])))
    array('Field'=>'TXID', 'Value'=>$_POST['txid'])
    array('Field'=>'PaymentDetails', 'Value'=>$_POST['paymentdetails'])
    array('Field'=>'AuthCode', 'Value'=>$_POST['authcode'])
  )
);

// Create JSON object to POST to SocketLabs
$data = new stdClass();
$data->ServerId=SOCKETLABS_SERVERID;
$data->ApiKey=SOCKETLABS_KEY;
$data->Messages= array(array('MergeData'=>$merge_data,
                        'Subject'=>$_POST['subject'],
                        'To'=>array(array('EmailAddress'=>'%%DeliveryAddress%%')),
                        'From'=>array('EmailAddress'=>$administrator),
                        'HtmlBody'=>'<div style="width:600px">Dear %%Name%%,<br/>Thank you for your order.  The details are shown below:<br/><br/>
                                    <h3 style="background:#ccc;color:#fff">Order Information</h3>
                                    Description: Goods or Services<br/><hr>
                                    <table>
                                      <tr>
                                        <td>
                                          <b>Billing Information</b><br/>
                                          %%Billing%%<br/>
                                          %%DeliveryAddress%%<br/>
                                          %%Phone%%<br/>
                                        </td>
                                        <td>
                                          <b>Shipping Information</b><br/>
                                          %%Shipping%%<br/>
                                        </td>
                                      </tr>
                                    </table>
                                    <h3 style="background:#ccc;color:#fff">Payment Information</h3>
                                    <table>
                                      <tr>
                                        <td>
                                          Date/Time:<br/>
                                          Transaction ID:<br/>
                                          Payment Method<br/>
                                          Transaction Type:<br/>
                                          Auth Code:<br/>
                                        </td>
                                        <td>
                                          %%DateTime%%<br/>
                                          %%TXID%%<br/>
                                          %%PaymentDetails%%<br/>
                                          Purchase<br/>
                                          %%AuthCode%%<br/>
                                        </td>
                                      </tr>
                                    </table>
                                    <h3 style="background:#ccc;color:#fff">Merchant Contact Information</h3>
                                    
                                    </div>'

                      ));
$bodyJson = json_encode($data);
//echo $bodyJson;

//use CURL to POST the JSON to SocketLabs
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL,SOCKETLABS_URL);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1 );
curl_setopt($ch, CURLOPT_POST,           1 );
curl_setopt($ch, CURLOPT_POSTFIELDS,     $bodyJson );
curl_setopt($ch, CURLOPT_HTTPHEADER,     array('Content-Type: application/json'));
$result=curl_exec ($ch);
curl_close ($ch);

//process result
if ($result==false) {
  echo 'HTTP Error';
} else {
    $result_obj = json_decode($result);
    if ($result_obj->ErrorCode=='Success') {
       echo 'Successfully sent all messages.';
    } elseif ($result_obj->ErrorCode=='Warning') {
       echo 'At least one message was sent, but there are errors with one or more messages, or their recipients.';
       //not shown here, but you can traverse the MessageResults object to get more information on each message that encountered an error or warning
    } else {
       echo 'Failure Code: ' . $result_obj->ErrorCode;
    }
}
