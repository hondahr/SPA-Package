<?php

include 'ajax.php';

    include_once '../includes/RocketShipIt/autoload.php';
    $rate = new \RocketShipIt\Rate('fedex');
    $freightrate = new \RocketShipIt\Rate('fedex');
    $rate->setParameter('shipCode', $_POST['senderzip']);
    $freightrate->setParameter('shipCode', $_POST['senderzip']);
    $rate->setParameter('toCode', $_POST['recipientzip']);
    $freightrate->setParameter('toCode', $_POST['recipientzip']);
    $dimsloc = $_POST['dimsloc'];
    //~ pr($dimsloc);
    $dimensions = '';
    //~ $numitems = count($dimsloc);
    $package = new \RocketShipIt\Package('fedex');
    $freightpackage = new \RocketShipIt\Package('fedex');
    $quote = 0;
    for($i=0;$i<count($dimsloc);$i++){
      if($i%2==0){
        //~ echo $i;exit;
        $ex = explode('_',$dimsloc[$i]);
        $loc = $ex[0];
        $l = $ex[1];
        $w = $ex[2];
        $h = $ex[3];
        $wt = $ex[4];
        $qty = $ex[5];
        //~ echo $qty;exit;
      } else {
        $id = $dimsloc[$i];
        //~ echo $id;exit;
      }
      //~ $dimensions = $ex[1]+$ex[2]+$ex[3];

      $package->setParameter('length', $l);
      $package->setParameter('width', $w);
      $package->setParameter('height', $h);
      $package->setParameter('weight', $wt);
      $freightpackage->setParameter('length', $l);
      $freightpackage->setParameter('width', $w);
      $freightpackage->setParameter('height', $h);
      $freightpackage->setParameter('weight', $wt);

      if($wt > 150){
        $freightrate->setParameter('service', 'FEDEX_FREIGHT_ECONOMY');
        $freightrate->setParameter('freightAccountNumber','527383927');
        $freightrate->setParameter('freightClass', 'CLASS_100');
        $freightrate->setParameter('shipAddr1', '178 TRUVER RD');//do not change these values!!!
        $freightrate->setParameter('shipCity', 'VALENCIA');
        $freightrate->setParameter('shipState', 'PA');
        $freightrate->setParameter('shipCode', '16059');
        $freightrate->setParameter('residentialAddressIndicator', '0');
        $freightrate->addPackageToShipment($package);
        $freight = $freightrate->getRate();
      } else if($wt > 0){
        $freight = 0;
        $rate->setParameter('residentialAddressIndicator', '0');
        $rate->addPackageToShipment($package);
        $response = $rate->getRate();
      }
      //~ echo $rate->debug();
    //~ pr($response);
    if($wt <= 150 && $wt > 0){
      //~ echo $wt;
      $quote += $response[RateReply][RateReplyDetails][6][RatedShipmentDetails][0][ShipmentRateDetail][TotalNetFedExCharge][Amount];
    } else if($wt > 150){
      $quote += $freight[RateReply][RateReplyDetails][RatedShipmentDetails][1][ShipmentRateDetail][TotalNetCharge][Amount];
    } else {
      $handling = getHandling($id);
      $quote += $handling*$qty;
    }
    //~ echo $quote;exit;
  }

  echo $quote;
